<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Bar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <!-- Auth Overlay -->
    <div id="authOverlay" style="display:none; position:fixed; inset:0; background:#F5F5F4; z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; border:1px solid #ddd; border-radius:8px; padding:32px 40px; max-width:380px; width:100%; box-shadow:0 2px 12px rgba(0,0,0,0.08);">
        <div id="loginForm">
        <h2 style="margin-top:0;">Sign In</h2>
        <div id="authError" style="color:#c01e19; font-size:0.85em; min-height:1.2em;"></div>
        <div style="margin-bottom:14px;"><label style="font-size:0.85em;font-weight:600;color:#57534E;">Email</label><br>
            <input type="email" id="loginEmail" placeholder="you@example.com" style="width:100%;padding:10px 12px;font-size:14px;border:2px solid #ddd;border-radius:4px;box-sizing:border-box;"></div>
        <div style="margin-bottom:14px;"><label style="font-size:0.85em;font-weight:600;color:#57534E;">Password</label><br>
            <input type="password" id="loginPassword" placeholder="Password" style="width:100%;padding:10px 12px;font-size:14px;border:2px solid #ddd;border-radius:4px;box-sizing:border-box;"></div>
        <button onclick="handleLogin()" style="width:100%;padding:10px;font-size:15px;background:#be7a15;color:white;border:none;border-radius:4px;cursor:pointer;">Sign In</button>
        <div style="margin-top:14px;text-align:center;font-size:0.9em;color:#666;">Don't have an account? <a onclick="showRegisterForm()" style="color:#be7a15;cursor:pointer;">Register</a></div>
        </div>
        <div id="registerForm" style="display:none;">
        <h2 style="margin-top:0;">Create Account</h2>
        <div style="margin-bottom:14px;"><label style="font-size:0.85em;font-weight:600;color:#57534E;">Email</label><br>
            <input type="email" id="registerEmail" placeholder="you@example.com" style="width:100%;padding:10px 12px;font-size:14px;border:2px solid #ddd;border-radius:4px;box-sizing:border-box;"></div>
        <div style="margin-bottom:14px;"><label style="font-size:0.85em;font-weight:600;color:#57534E;">Password</label><br>
            <input type="password" id="registerPassword" placeholder="Min 8 characters" style="width:100%;padding:10px 12px;font-size:14px;border:2px solid #ddd;border-radius:4px;box-sizing:border-box;"></div>
        <div style="margin-bottom:14px;"><label style="font-size:0.85em;font-weight:600;color:#57534E;">Confirm Password</label><br>
            <input type="password" id="registerConfirm" placeholder="Confirm password" style="width:100%;padding:10px 12px;font-size:14px;border:2px solid #ddd;border-radius:4px;box-sizing:border-box;"></div>
        <button onclick="handleRegister()" style="width:100%;padding:10px;font-size:15px;background:#be7a15;color:white;border:none;border-radius:4px;cursor:pointer;">Create Account</button>
        <div style="margin-top:14px;text-align:center;font-size:0.9em;color:#666;">Already have an account? <a onclick="showLoginForm()" style="color:#be7a15;cursor:pointer;">Sign In</a></div>
        </div>
    </div>
    </div>

    <!-- User Bar -->
    <div id="userBar" style="display:none; position:fixed; top:0; left:0; right:0; height:36px; background:#57534E; color:#eee; align-items:center; justify-content:flex-end; padding:0 20px; gap:12px; font-size:0.82em; z-index:500;">
    <span id="userEmail"></span>
    <span id="userRole" style="background:#d9af6f;color:#57534E;padding:1px 8px;border-radius:3px;font-weight:600;font-size:0.9em;text-transform:uppercase;"></span>
    <button onclick="handleLogout()" style="background:none;border:1px solid #999;color:#ccc;padding:2px 10px;border-radius:3px;cursor:pointer;">Sign Out</button>
    </div>

    <div id="appContainer" class="main-layout" style="display:none; margin-top:36px;">
        <!-- Left Panel -->
        <div class="left-panel-container">
            <!--Drop Zone-->
            <div class="drop-zone" id="dropZone">
                <h3>Assets</h3>
                <div id="selectedItems">
                    <p id="placeholder" style="color: #999; font-style: italic;">Drag and drop your assets here...</p>
                </div>
            </div>
            <!--CVE Counter-->
            <div class="cveCounts-container">
                <div id="cveCounts">0 CVEs found</div>
            </div>
            
            <!--Chart Configuration-->
            <div id="chartConfig" class="chart-config">
                <div class="config-row">
                    <label for="riskFormulaSelect">Risk Formula</label>
                    <select id="riskFormulaSelect">
                        <option value="weighted_average" selected>Weighted Average</option>
                        <option value="multiplicative">Multiplicative</option>
                        <option value="max">Max Score</option>
                        <option value="simple_mean">Simple Mean</option>
                    </select>
                </div>
                <div class="config-row">
                    <label for="aggMethodSelect">Aggregation Method</label>
                    <select id="aggMethodSelect">
                        <option value="max">Max</option>
                        <option value="mean" selected>Mean</option>
                        <option value="median">Median</option>
                        <option value="sum">Sum</option>
                    </select>
                </div>
                <div class="config-row">
                    <label for="riskThresholdSlider">Risk Threshold: <span id="thresholdValue">7.0</span></label>
                    <input type="range" id="riskThresholdSlider" min="0" max="10" step="0.5" value="7">
                </div>
            </div>
        </div>

        <!--Search Filters Modal-->
        <div class="modal-overlay" id="searchFilterModal" style="display: none;">
            <div class="modal-content filter-panel">
                <div class="modal-header">
                    <h3>Filters</h3>
                    <button class="modal-close-btn" id="closeFilterModal">&times;</button>
                </div>
                <div class="filter-fields">
                    <div class="filter-field">
                        <label for="filterDeprecated">Deprecated</label>
                        <select id="filterDeprecated">
                            <option value="">Any</option>
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label>Date(s) Created</label>
                        <div id="dateSliderContainer" style="position:relative; height:36px; margin-top:4px;">
                            <input type="range" id="filterDateFrom" min="0" max="100" value="0" style="position:absolute; width:100%; pointer-events:none; background:none; -webkit-appearance:none; appearance:none; height:6px; top:14px; z-index:2;">
                            <input type="range" id="filterDateTo" min="0" max="100" value="100" style="position:absolute; width:100%; pointer-events:none; background:none; -webkit-appearance:none; appearance:none; height:6px; top:14px; z-index:2;">
                            <div id="dateSliderTrack" style="position:absolute; height:6px; background:#ddd; border-radius:3px; width:100%; top:14px; z-index:0;"></div>
                            <div id="dateSliderRange" style="position:absolute; height:6px; background:#d9af6f; border-radius:3px; top:14px; z-index:1;"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:0.75em; color:#888;">
                            <span id="dateSliderMinLabel">—</span>
                            <span id="dateSliderMaxLabel">—</span>
                        </div>
                    </div>
                    <div class="filter-field">
                        <label for="filterVendor">Vendor</label>
                        <input type="text" id="filterVendor" placeholder="e.g. microsoft">
                    </div>
                    <div class="filter-field">
                        <label for="filterProduct">Product</label>
                        <input type="text" id="filterProduct" placeholder="e.g. windows">
                    </div>
                    <div class="filter-field">
                        <label for="filterVersion">Version</label>
                        <input type="text" id="filterVersion" placeholder="e.g. 1.0">
                    </div>
                    <div class="filter-field">
                        <label for="filterUpdate">Update</label>
                        <input type="text" id="filterUpdate" placeholder="e.g. sp1">
                    </div>
                    <div class="filter-field">
                        <label for="filterEdition">Edition</label>
                        <input type="text" id="filterEdition" placeholder="e.g. enterprise">
                    </div>
                    <div class="filter-field">
                        <label for="filterLanguage">Language</label>
                        <input type="text" id="filterLanguage" placeholder="e.g. en">
                    </div>
                    <div class="filter-field">
                        <label for="filterSwEdition">SW Edition</label>
                        <input type="text" id="filterSwEdition" placeholder="e.g. pro">
                    </div>
                    <div class="filter-field">
                        <label for="filterTargetSw">Target SW</label>
                        <input type="text" id="filterTargetSw" placeholder="e.g. windows">
                    </div>
                    <div class="filter-field">
                        <label for="filterTargetHw">Target HW</label>
                        <input type="text" id="filterTargetHw" placeholder="e.g. x64">
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#" id="clearFilters" class="advanced-search-link">Clear Filters</a>
                    <button id="applyFilters" class="filter-apply-btn">Apply</button>
                </div>
            </div>
        </div>

        <!-- Tab Container -->
        <div class="tab-container" style="display: flex; flex-direction: column;">
            <div class="tab-header">
                <button class="tab-button active" data-tab="search">Search</button>
                <button class="tab-button" data-tab="cve">Asset Directory</button>
                <button class="tab-button" data-tab="charts">Charts</button>
                <button class="tab-button" data-tab="tickets">myTickets</button>
            </div>
            <div class="tab-content">

                <!--Search Tab-->
                <div class="tab-panel active" data-panel="search">
                    <h2>Search CPEs</h2>
                    <!-- Simple Search -->
                    <div id="simpleSearch">
                        <div class="search-container">
                            <input type="text" id="searchInput" placeholder="Search...">
                            <button id="searchButton">Search</button>
                        </div>
                        <a href="#" id="toggleAdvancedSearch" class="advanced-search-link">Advanced Search</a>
                    </div>
                    <!-- Advanced Search -->
                    <div id="advancedSearch" style="display: none;">
                        <a href="#" id="toggleSimpleSearch" class="advanced-search-link">&#8592; Go Back to Search</a>
                        <div class="advanced-search-grid">
                            <div class="adv-field">
                                <label for="advPart">Part</label>
                                <select id="advPart">
                                    <option value="" selected>Any</option>
                                    <option value="a">Application (a)</option>
                                    <option value="h">Hardware (h)</option>
                                    <option value="o">Operating System (o)</option>
                                </select>
                            </div>
                            <div class="adv-field">
                                <label for="advVendor">Vendor</label>
                                <input type="text" id="advVendor" placeholder="e.g. microsoft">
                            </div>
                            <div class="adv-field">
                                <label for="advProduct">Product</label>
                                <input type="text" id="advProduct" placeholder="e.g. windows_10">
                            </div>
                            <div class="adv-field">
                                <label for="advVersion">Version</label>
                                <input type="text" id="advVersion" placeholder="e.g. 1.0.0">
                            </div>
                            <div class="adv-field">
                                <label for="advUpdate">Update</label>
                                <input type="text" id="advUpdate" placeholder="e.g. sp1">
                            </div>
                            <div class="adv-field">
                                <label for="advEdition">Edition</label>
                                <input type="text" id="advEdition" placeholder="e.g. enterprise">
                            </div>
                            <div class="adv-field">
                                <label for="advLanguage">Language</label>
                                <input type="text" id="advLanguage" placeholder="e.g. en">
                            </div>
                            <div class="adv-field">
                                <label for="advSwEdition">Software Edition</label>
                                <input type="text" id="advSwEdition" placeholder="e.g. pro">
                            </div>
                            <div class="adv-field">
                                <label for="advTargetSw">Target Software</label>
                                <input type="text" id="advTargetSw" placeholder="e.g. windows">
                            </div>
                            <div class="adv-field">
                                <label for="advTargetHw">Target Hardware</label>
                                <input type="text" id="advTargetHw" placeholder="e.g. x64">
                            </div>
                            <div class="adv-field">
                                <label for="advOther">Other</label>
                                <input type="text" id="advOther" placeholder="Miscellaneous">
                            </div>
                        </div>
                        <div class="search-container" style="margin-top: 12px;">
                            <button id="advSearchButton">Search</button>
                        </div>
                    </div>
                    <!--Results Container-->
                    <div id="searchingContainer" style="display: none;">
                        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 100%;">
                            <img class="ufo" src="/static/img/ufo4.svg" alt="UFO" />
                            <p style="font-size: 1.2em; color: #888;">Searching<span class="dots"></span></p>
                        </div>
                    </div>
                    <div id="resultsContainer" style="display: none;">
                        <div style="display: flex; flex-direction: row; justify-content: space-between; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <h2>Results</h2>
                                <a href="#" id="clearResults">Clear Results</a>
                            </div>
                            <div style="display: inline-flex; gap: 6px; align-items: flex-end;">
                                <span id="openSearchFilterModal" style="display:none; cursor:pointer; color:#be7a15; font-size:1.2em;">
                                    <i class="fa-solid fa-filter"></i>
                                </span>
                            </div>
                        </div>
                        <div id="resultsList"></div>
                        <div id="pagination" style="display: none; margin-top: 20px; text-align: center;">
                            <button id="prevPage" disabled>Previous</button>
                            <span style="margin: 0 15px;">
                                Page <input type="text" id="pageInput" min="1" value="1" style="width: 25px; text-align: center;"> of <span id="totalPages"></span>
                            </span>
                            <button id="nextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>

                <!--Charts Tab-->
                <div class="tab-panel" data-panel="charts">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <h2>Charts</h2>
                        <button id="chartFullscreenToggle" class="chart-fullscreen-btn" style="display: none;" title="Expand chart">&#x26F6;</button>
                    </div>
                    <p id="chartPlaceholder" style="color: #999; font-style: italic;">Add assets to generate charts.</p>
                    <div style="position: relative; width: 100%;">
                        <canvas id="epssChart" style="display: none;"></canvas>
                        <canvas id="cvssHistogramChart" style="display: none; max-width: 600px;"></canvas>
                    </div>
                </div>

                <!--CVE Tab-->
                <div class="tab-panel" data-panel="cve">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <h2>Asset Directory</h2>
                        <span id="manageAssetsBtn" style="cursor:pointer; color:#be7a15; font-size:0.9em;">⚙ Manage Assets</span>
                    </div>
                    <div id="manageAssetsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:900; justify-content:center; align-items:center;">
                    <div style="background:white; border-radius:8px; padding:24px 32px; max-width:500px; width:90%; max-height:70vh; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0;">Manage Assets</h3>
                        <span id="closeManageAssets" style="cursor:pointer; font-size:1.3em; color:#888;">&times;</span>
                        </div>
                        <p style="font-size:0.85em; color:#666;">Delete or archive assets. Archived assets are hidden from CVE Details and Charts but can be restored.</p>
                        <div id="manageAssetsList"></div>
                        <div style="margin-top:14px; text-align:right;">
                        <button id="showArchivedToggle" style="padding:6px 14px; font-size:0.85em; background:none; border:1px solid #ccc; border-radius:4px; cursor:pointer;">Show Archived</button>
                        </div>
                    </div>
                    </div>
                    <div id="cveGrid" class="cve-grid"></div>
                    <div id="cveFolderView" style="display: none;">
                        <a href="#" class="cve-folder-back" id="cveFolderBack">← Back to assets</a>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 id="cveFolderTitle"></h3>
                            <span id="cpeInfoIcon" class="cpe-info-icon" title="View CPE Information">&#x1F6C8;</span>
                            <button class="folder-dl-btn" onclick="downloadCveCSV()">CSV</button>
                            <button class="folder-dl-btn" onclick="downloadCveJSON()">JSON</button>
                        </div>
                        <div class="cve-folder-scroll">
                            <table id="cveFolderTable" class="cve-detail-table">
                                <thead>
                                    <tr>
                                        <th data-sort="id">CVE ID <span class="sort-arrow"></span></th>
                                        <th data-sort="published">Published <span class="sort-arrow"></span></th>
                                        <th data-sort="kev">KEV <span class="sort-arrow"></span></th>
                                        <th data-sort="epss">EPSS <span class="sort-arrow"></span></th>
                                        <th data-sort="cwe">CWE <span class="sort-arrow"></span></th>
                                        <th data-sort="status">Status <span class="sort-arrow"></span></th>
                                        <th data-sort="tags">Tags <span class="sort-arrow"></span></th>
                                        <th data-sort="cvss">CVSS <span class="sort-arrow"></span></th>
                                        <th data-sort="severity">Severity <span class="sort-arrow"></span></th>
                                    </tr>
                                </thead>
                                <tbody id="cveFolderBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!--myTickets Tab-->
                <div class="tab-panel" data-panel="tickets">
                    <h2>myTickets</h2>
                    <div style="margin-bottom: 15px; justify-content: space-between; display: flex; align-items: center; max-width: 600px;">
                        <span id="createTicketBtn" style="cursor: pointer; color: #be7a15; font-size: 1.1em;">&#65291; Create New Ticket</span>
                        <span id="filterBtn" onclick="openFilterModal()" style="cursor: pointer; color: #be7a15; font-size: 1.2em;">
                            <i class="fa-solid fa-filter"></i>
                        </span>
                    </div>
                    <div id="ticketFormContainer" style="display: none; max-width: 600px; border: 1px solid #ddd; border-radius: 6px; padding: 16px; background: #fafafa; margin-bottom: 20px;">
                        <h3 style="margin-top: 0;">New Remediation Ticket</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div>
                                <label style="font-weight: 600; font-size: 0.85em; color: #57534E;">Description</label>
                                <textarea id="ticketDescription" rows="4" style="width: 100%; padding: 8px; font-size: 14px; border: 2px solid #ddd; border-radius: 4px; resize: vertical; box-sizing: border-box;" placeholder="Describe the issue to be remediated..."></textarea>
                            </div>
                            <div>
                                <label style="font-weight: 600; font-size: 0.85em; color: #57534E;">Related Feature</label>
                                <select id="ticketFeature" style="width: 100%; padding: 8px 10px; font-size: 14px; border: 2px solid #ddd; border-radius: 4px; background: white;">
                                    <option value="" selected>— Select feature —</option>
                                    <option value="Search">Search</option>
                                    <option value="Charts">Charts</option>
                                    <option value="Asset Directory">Asset Directory</option>
                                    <option value="myTickets">myTickets</option>
                                    <option value="Left Panel">Left Panel</option>
                                    <option value="Right Panel">Right Panel</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button id="submitTicketBtn" style="padding: 8px 20px; background-color: #be7a15; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Submit Ticket</button>
                                <button id="cancelTicketBtn" style="padding: 8px 20px; background-color: #ccc; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div id="ticketsList"></div>
                </div>
            </div>
        </div>
        
        <!--Right Panel-->
        <div class="right-panel-container" style="display: none;">
            <button id="toggleRightPanel" class="panel-toggle-btn" style="display: none;">&#9654;</button>
            <div id="rightPanelContent">
                <!--Vulnerabilities-->
                <div id="cveContainer" style="display: none;">
                    <ul id="cveList" style="list-style: none; padding: 0;"></ul>
                </div>
                <div id="expandedViewContainer" style="display: none;">
                    <div id="expandedDetails"></div>
                </div>
            </div>
        </div>
        <div id="filterModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
            <div style="background:#fff; border-radius:10px; padding:25px; width:400px; max-width:90%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">Filter Tickets</h3>
                <span onclick="closeFilterModal()" style="cursor:pointer; font-size:1.4em;">&times;</span>
            </div>
        
            <label style="display:block; margin-bottom:5px; font-weight:600;">Feature</label>
            <select id="filterFeature" style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px;">
                <option value="">All</option>
            </select>
        
            <label style="display:block; margin-bottom:5px; font-weight:600;">Date Created</label>
            <input type="date" id="filterDate" style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;">
        
            <label style="display:block; margin-bottom:5px; font-weight:600;">Ticket Owner</label>
            <select id="filterOwner" style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px;">
                <option value="">All</option>
            </select>
        
            <label style="display:block; margin-bottom:5px; font-weight:600;">Ticket Status</label>
            <select id="filterStatus" style="width:100%; padding:8px; margin-bottom:20px; border:1px solid #ccc; border-radius:5px;">
                <option value="">All</option>
                <option value="Open">Open</option>
                <option value="In Progress">In Progress</option>
                <option value="Resolved">Resolved</option>
                <option value="Archived">Archived</option>
            </select>
        
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:20px; font-weight:600; cursor:pointer;">
                <input type="checkbox" id="filterIncludeArchived" style="accent-color:#be7a15; width:16px; height:16px;">
                Include Archived Tickets
            </label>

            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="clearFilters()" style="padding:8px 16px; border:1px solid #ccc; border-radius:5px; background:#fff; cursor:pointer;">Clear</button>
                <button onclick="applyFilters()" style="padding:8px 16px; border:none; border-radius:5px; background:#be7a15; color:#fff; cursor:pointer;">Apply</button>
            </div>
            </div>
        </div>
</body>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="/static/state.js"></script>
    <script src="/static/auth.js"></script>
    <script src="/static/panel.js"></script>
    <script src="/static/tabs.js"></script>
    <script src="/static/search.js"></script>
    <script src="/static/dragdrop.js"></script>
    <script src="/static/charts.js"></script>
    <script src="/static/cve.js"></script>
    <script src="/static/filters.js"></script>
    <script src="/static/export.js"></script>
    <script src="/static/tickets.js"></script>
    <script src="/static/manage.js"></script>
</html>